#!/usr/bin/env node

/* ç”¨é€”ï¼šæµ‹è¯•è¾©è®ºè¯„å§”ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ
ç”¨æ³•ï¼šnode test-judge.js
*/

const { loadConfig } = require('./src/config');
const { DebateJudge } = require('./src/judge');
const { createLogger } = require('./src/logger');

async function testJudge() {
  console.log('ğŸ§ª å¼€å§‹æµ‹è¯•è¾©è®ºè¯„å§”ç³»ç»Ÿ...\n');

  // åŠ è½½é…ç½®
  const config = loadConfig();
  console.log('âœ… é…ç½®åŠ è½½æˆåŠŸ');

  // åˆ›å»ºæ—¥å¿—è®°å½•å™¨
  const logger = createLogger(config);
  console.log('âœ… æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');

  // åˆ›å»ºè¯„å§”ç³»ç»Ÿ
  const judge = new DebateJudge(config, logger);
  console.log('âœ… è¯„å§”ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ\n');

  // æµ‹è¯•ç”¨ä¾‹1ï¼šè¯„ä¼°å•è½®è¾©è®º
  console.log('ğŸ“ æµ‹è¯•1ï¼šè¯„ä¼°å•è½®è¾©è®º...');
  try {
    const evaluation = await judge.evaluateRound({
      topic: 'äººå·¥æ™ºèƒ½åº”å¦ä¼˜å…ˆç”¨äºå…¬å…±æ²»ç†è€Œéå•†ä¸šè¥é”€ï¼Ÿ',
      stage: 'é™ˆè¯é˜¶æ®µ-ç«‹è®ºé™ˆè¯',
      stageKey: 'opening',
      stageRule: 'æ­£æ–¹ä¸€è¾©é™ˆè¯3åˆ†é’Ÿï¼Œåæ–¹ä¸€è¾©é™ˆè¯3åˆ†é’Ÿã€‚',
      replyA: 'å„ä½è¯„å§”ã€å¯¹æ–¹è¾©å‹ï¼Œå¤§å®¶å¥½ã€‚é’ˆå¯¹è¾©é¢˜"äººå·¥æ™ºèƒ½åº”å¦ä¼˜å…ˆç”¨äºå…¬å…±æ²»ç†è€Œéå•†ä¸šè¥é”€"ï¼Œæˆ‘æ–¹åšå®šè®¤ä¸ºï¼šäººå·¥æ™ºèƒ½åº”å½“ä¼˜å…ˆæœåŠ¡äºå…¬å…±æ²»ç†ã€‚ç¬¬ä¸€ï¼Œä»ä»·å€¼æ’åºçš„åº•å±‚é€»è¾‘æ¥çœ‹ï¼Œå…¬å…±æ²»ç†è§£å†³çš„æ˜¯"ç”Ÿå­˜ä¸å‘å±•"çš„å…¬å…±æ€§é—®é¢˜ï¼Œè€Œå•†ä¸šè¥é”€è§£å†³çš„æ˜¯"æ¬²æœ›ä¸æ¶ˆè´¹"çš„ç§äººé—®é¢˜ã€‚æ ¹æ®é©¬æ–¯æ´›éœ€æ±‚å±‚æ¬¡ç†è®ºï¼Œåœ¨åŸºç¡€çš„ç¤¾ä¼šå…¬å¹³ä¸å®‰å…¨éœ€æ±‚æœªå¾—åˆ°å……åˆ†æ»¡è¶³ä¹‹å‰ï¼Œé«˜å±‚æ¬¡çš„éœ€æ±‚æ˜¯ä¸ç¨³å›ºçš„ã€‚',
      replyB: 'è¯„å§”ï¼Œå¯¹æ–¹è¾©å‹ï¼Œæˆ‘æ–¹åšå†³åå¯¹"ä¼˜å…ˆ"è¿™ä¸€ç»å¯¹åŒ–çš„è¡¨è¿°ã€‚æ­£æ–¹çš„é€»è¾‘å»ºç«‹åœ¨ä¸€ç§è™šå‡çš„äºŒå…ƒå¯¹ç«‹ä¹‹ä¸Šï¼Œè¯•å›¾å°†å…¬å…±æ²»ç†ä¸å•†ä¸šè¥é”€ç½®äºé›¶å’Œåšå¼ˆä¸­ï¼Œè¿™ç§è§‚ç‚¹ä¸ä»…å¿½è§†äº†ç¤¾ä¼šå‘å±•çš„å¤æ‚æ€§ï¼Œæ›´æ©ç›–äº†å•†ä¸šè¥é”€ä½œä¸ºAIæŠ€æœ¯è¿­ä»£æ ¸å¿ƒå¼•æ“çš„å®¢è§‚äº‹å®ã€‚',
      speakerA: 'æ­£æ–¹ä¸€è¾©',
      speakerB: 'åæ–¹ä¸€è¾©',
      round: 1
    });

    console.log('   âœ… è¯„åˆ†æˆåŠŸï¼');
    console.log(`   ğŸ“Š æœ¬è½®èƒœæ–¹: ${evaluation.round_winner}`);
    console.log(`   ğŸ“Š æ­£æ–¹å¹³å‡åˆ†: ${evaluation.averages.A.toFixed(2)}`);
    console.log(`   ğŸ“Š åæ–¹å¹³å‡åˆ†: ${evaluation.averages.B.toFixed(2)}`);
    console.log(`   ğŸ’¡ æ­£æ–¹äº®ç‚¹: ${evaluation.highlights.A.join(', ') || 'æ— '}`);
    console.log(`   ğŸ’¡ åæ–¹äº®ç‚¹: ${evaluation.highlights.B.join(', ') || 'æ— '}`);
    console.log(`   ğŸ“ æ­£æ–¹å»ºè®®: ${evaluation.suggestions.A.join('; ') || 'æ— '}`);
    console.log(`   ğŸ“ åæ–¹å»ºè®®: ${evaluation.suggestions.B.join('; ') || 'æ— '}`);
  } catch (err) {
    console.error(`   âŒ è¯„åˆ†å¤±è´¥: ${err.message}`);
    console.error(err.stack);
    process.exit(1);
  }

  console.log('\n');

  // æµ‹è¯•ç”¨ä¾‹2ï¼šè¯„ä¼°æ•´åœºè¾©è®º
  console.log('ğŸ“ æµ‹è¯•2ï¼šè¯„ä¼°æ•´åœºè¾©è®º...');
  try {
    const debateHistory = `
=== Round 1 | Topic: äººå·¥æ™ºèƒ½åº”å¦ä¼˜å…ˆç”¨äºå…¬å…±æ²»ç†è€Œéå•†ä¸šè¥é”€ï¼Ÿ ===
[2026-02-05 16:00:00] A (Round 1)
Stage: é™ˆè¯é˜¶æ®µ-ç«‹è®ºé™ˆè¯
å„ä½è¯„å§”ã€å¯¹æ–¹è¾©å‹ï¼Œå¤§å®¶å¥½ã€‚é’ˆå¯¹è¾©é¢˜"äººå·¥æ™ºèƒ½åº”å¦ä¼˜å…ˆç”¨äºå…¬å…±æ²»ç†è€Œéå•†ä¸šè¥é”€"ï¼Œæˆ‘æ–¹åšå®šè®¤ä¸ºï¼šäººå·¥æ™ºèƒ½åº”å½“ä¼˜å…ˆæœåŠ¡äºå…¬å…±æ²»ç†ã€‚ç¬¬ä¸€ï¼Œä»ä»·å€¼æ’åºçš„åº•å±‚é€»è¾‘æ¥çœ‹ï¼Œå…¬å…±æ²»ç†è§£å†³çš„æ˜¯"ç”Ÿå­˜ä¸å‘å±•"çš„å…¬å…±æ€§é—®é¢˜ï¼Œè€Œå•†ä¸šè¥é”€è§£å†³çš„æ˜¯"æ¬²æœ›ä¸æ¶ˆè´¹"çš„ç§äººé—®é¢˜ã€‚

[2026-02-05 16:00:30] B (Round 1)
Stage: é™ˆè¯é˜¶æ®µ-ç«‹è®ºé™ˆè¯
è¯„å§”ï¼Œå¯¹æ–¹è¾©å‹ï¼Œæˆ‘æ–¹åšå†³åå¯¹"ä¼˜å…ˆ"è¿™ä¸€ç»å¯¹åŒ–çš„è¡¨è¿°ã€‚æ­£æ–¹çš„é€»è¾‘å»ºç«‹åœ¨ä¸€ç§è™šå‡çš„äºŒå…ƒå¯¹ç«‹ä¹‹ä¸Šã€‚

=== Round 2 | Topic: äººå·¥æ™ºèƒ½åº”å¦ä¼˜å…ˆç”¨äºå…¬å…±æ²»ç†è€Œéå•†ä¸šè¥é”€ï¼Ÿ ===
[2026-02-05 16:01:00] A (Round 2)
Stage: æ”»è¾©é˜¶æ®µ-æ­£æ–¹äºŒè¾©æé—®
å¯¹æ–¹è¾©å‹ï¼Œæ‚¨æåˆ°å•†ä¸šç«äº‰èƒ½å¸¦æ¥é€æ˜åº¦ï¼Œä½†å•†ä¸šAIçš„æ ¸å¿ƒé€»è¾‘æ˜¯è¿½æ±‚åˆ©æ¶¦ï¼Œå¾€å¾€åˆ©ç”¨ç®—æ³•æ“çºµç”¨æˆ·å¿ƒç†ã€‚

[2026-02-05 16:01:30] B (Round 2)
Stage: æ”»è¾©é˜¶æ®µ-æ­£æ–¹äºŒè¾©æé—®
å¯¹æ–¹è¾©å‹ï¼Œæ‚¨å°†"é€åˆ©"ç­‰åŒäº"ç ´å"ï¼Œè¿™æ˜¯ä¸€ç§å…¸å‹çš„é“å¾·ç»‘æ¶ã€‚å•†ä¸šAIè¿½æ±‚åˆ©æ¶¦ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¼ä¸šä¸ºäº†ç”Ÿå­˜å¿…é¡»æä¾›æ›´ä¼˜è´¨ã€æ›´ä¾¿æ·çš„æœåŠ¡ã€‚
`;

    const finalEvaluation = await judge.evaluateDebate(debateHistory, 'äººå·¥æ™ºèƒ½åº”å¦ä¼˜å…ˆç”¨äºå…¬å…±æ²»ç†è€Œéå•†ä¸šè¥é”€ï¼Ÿ');

    console.log('   âœ… æœ€ç»ˆè¯„åˆ¤æˆåŠŸï¼');
    console.log(`   ğŸ† æœ€ç»ˆèƒœæ–¹: ${finalEvaluation.winner === 'A' ? 'æ­£æ–¹' : finalEvaluation.winner === 'B' ? 'åæ–¹' : 'å¹³å±€'}`);
    console.log(`   ğŸ“Š æ­£æ–¹æ€»åˆ†: ${finalEvaluation.final_scores.A}/100`);
    console.log(`   ğŸ“Š åæ–¹æ€»åˆ†: ${finalEvaluation.final_scores.B}/100`);
    console.log(`   ğŸ”„ å…³é”®è½¬æŠ˜ç‚¹: ${finalEvaluation.key_turning_points.length}ä¸ª`);
    console.log(`   âš¡ å†³å®šæ€§å› ç´ : ${finalEvaluation.decisive_factors.join('; ')}`);
    console.log(`   ğŸ“ æ•´ä½“è¯„ä»·: ${finalEvaluation.overall_comment}`);
  } catch (err) {
    console.error(`   âŒ æœ€ç»ˆè¯„åˆ¤å¤±è´¥: ${err.message}`);
    console.error(err.stack);
    process.exit(1);
  }

  console.log('\n');

  // æµ‹è¯•ç”¨ä¾‹3ï¼šé»˜è®¤è¯„åˆ†
  console.log('ğŸ“ æµ‹è¯•3ï¼šé»˜è®¤è¯„åˆ†ï¼ˆé”™è¯¯æƒ…å†µï¼‰...');
  try {
    const defaultEval = judge.getDefaultEvaluation();
    console.log('   âœ… é»˜è®¤è¯„åˆ†è·å–æˆåŠŸï¼');
    console.log(`   ğŸ“Š é»˜è®¤æ­£æ–¹å¹³å‡åˆ†: ${defaultEval.averages.A}`);
    console.log(`   ğŸ“Š é»˜è®¤åæ–¹å¹³å‡åˆ†: ${defaultEval.averages.B}`);
    console.log(`   ğŸ“Š é»˜è®¤èƒœæ–¹: ${defaultEval.round_winner}`);
  } catch (err) {
    console.error(`   âŒ é»˜è®¤è¯„åˆ†å¤±è´¥: ${err.message}`);
    process.exit(1);
  }

  console.log('\nâœ¨ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼è¯„å§”ç³»ç»Ÿå·¥ä½œæ­£å¸¸ã€‚\n');

  // æµ‹è¯•æ€»ç»“
  console.log('ğŸ“‹ æµ‹è¯•æ€»ç»“ï¼š');
  console.log('   âœ… å•è½®è¯„åˆ†åŠŸèƒ½æ­£å¸¸');
  console.log('   âœ… æ•´åœºè¯„åˆ¤åŠŸèƒ½æ­£å¸¸');
  console.log('   âœ… é»˜è®¤è¯„åˆ†åŠŸèƒ½æ­£å¸¸');
  console.log('   âœ… é”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸');
  console.log('\nğŸ‰ è¾©è®ºç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹è¿è¡Œï¼');
}

// è¿è¡Œæµ‹è¯•
testJudge().catch(err => {
  console.error('\nâŒ æµ‹è¯•å¤±è´¥ï¼š', err);
  process.exit(1);
});
